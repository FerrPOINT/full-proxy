## üìÑ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ reverse‚Äëproxy —Å OpenResty/Lua –¥–ª—è Krea.ai

---

### üéØ –¶–µ–ª—å

–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ Krea.ai –ø–æ–¥ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–æ–º–µ–Ω `krea.acm‚Äëai.ru`, —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–æ–¥–º–µ–Ω–æ–π –¥–æ–º–µ–Ω–∞ –≤ –∫—É–∫–∞—Ö, –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö, fetch/XHR‚Äë–∑–∞–ø—Ä–æ—Å–∞—Ö –∏ localStorage. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–∞–∫ ¬´—Ä–æ–¥–Ω–æ–π¬ª, –±–µ–∑ —Ä–∞–∑—Ä—ã–≤–æ–≤ —Å–µ—Å—Å–∏–∏ –∏ –ª–æ–≥–∏–∫–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–π origin –±—Ä–∞—É–∑–µ—Ä–∞.

---

### ‚öôÔ∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Å—Ç—ç–∫

* **OpenResty** (NGINX + ngx\_http\_lua\_module)
  –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ Lua –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫. ([Ruby-Forum][1], [GitHub][2])

* **–ú–æ–¥—É–ª—å `lua-resty-cookie`**
  –î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –ø–µ—Ä–µ–ø–∏—Å–∏ `Set-Cookie` –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ ‚Äî —Ä–∞–∑–¥–µ–ª `Domain`, `Path`, `Flags`. ([groups.google.com][3])

* **–î–∏—Ä–µ–∫—Ç–∏–≤–∞ `proxy_cookie_domain` (NGINX)**
  –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–º–µ–Ω–∞ –¥–æ–º–µ–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∫—É–∫–∏. –û—Å—Ç–∞–≤–ª–µ–Ω–∞ –∫–∞–∫ fallback (—Å —Ä–µ–≥—É–ª—è—Ä–∫–∞–º–∏). ([nginx.org][4])

* **–î–∏—Ä–µ–∫—Ç–∏–≤–∞ `body_filter_by_lua_block` + `sub_filter`**
  –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–¥–º–µ–Ω—É –≤—Å–µ—Ö –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ `https://krea.ai` ‚Üí `https://krea.acm‚Äëai.ru`; –∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞. ([Stack Overflow][5])

---

### üõ† –ó–∞–¥–∞—á–∏

1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä `krea.acm‚Äëai.ru` –¥–ª—è SSL** (Let‚Äôs Encrypt).
2. **–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ**:

   * –í—Å–µ HTTP/HTTPS-–∑–∞–ø—Ä–æ—Å—ã (`/`) ‚Üí `https://krea.ai$request_uri`.
   * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å WebSocket, CORS, `OPTIONS`.
3. **–ü–µ—Ä–µ—Ö–≤–∞—Ç –∏ –ø–æ–¥–º–µ–Ω–∞ `Set-Cookie`**:

   * `header_filter_by_lua_block`: –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å `Domain=.krea.ai` –∏ `Domain=krea.ai` ‚Üí `Domain=krea.acm‚Äëai.ru`, –æ—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ flags ‚Äî `Secure`, `SameSite=None`. ([docs.nginx.com][6], [Ruby-Forum][1])
   * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –º–Ω–æ–≥–æ (`ngx.header["Set-Cookie"]` ‚Äî table –∏–ª–∏ string).
4. **–ü–æ–¥–º–µ–Ω–∞ URL**:

   * `body_filter_by_lua_block`: –∑–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `https://krea.ai`, `https://www.krea.ai`, `php.krea.ai` –∏ bare `krea.ai`, `www.krea.ai` –Ω–∞ `krea.acm‚Äëai.ru` –≤ HTML/JS.
   * –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Content-Length`, —á—Ç–æ–±—ã Lua-–º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è –Ω–µ –ª–æ–º–∞–ª–∞ –ø–æ—Ç–æ–∫. ([groups.google.com][3], [Stack Overflow][7])
   * –û—Ç–∫–ª—é—á–µ–Ω–∏–µ `Accept-Encoding`, —á—Ç–æ–±—ã sub\_filter —Å—Ä–∞–±–æ—Ç–∞–ª –¥–ª—è —Å–∂–∞—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. ([Reddit][8])
5. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**:

   * `X-Frame-Options: ALLOWALL`
   * `Content-Security-Policy: frame-ancestors *`
   * `Access-Control-Allow-Credentials: true`, `Allow-Methods`, `Allow-Headers` ‚Äî —á—Ç–æ–±—ã iframe –∏ fetch –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ —Å—á–∏—Ç–∞–ª–∏—Å—å same-origin.
6. **–¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `/krea-test.html`**:

   * –° iframe `<iframe src="https://krea.acm‚Äëai.ru/" allow="...">`, –±–µ–∑ —Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ –Ω—ë–º, —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞.
7. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:

   * `access_log`, `error_log` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã.
   * –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `Set-Cookie`, —á–µ—Ä–µ–∑ `lua` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ngx.log(ngx.ERR, cookies)`).
8. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:

   * –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ OpenResty, –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Lua-–º–æ–¥—É–ª—è.
   * –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (`nginx -t && nginx reload`).
   * –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –æ—á–∏—Å—Ç–∫–µ –∫—É–∫–∏ –∏ –∫–µ—à–∞ –∏ –ø–æ –ø–æ—à–∞–≥–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ.
   * –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç (—Å–º. –Ω–∏–∂–µ).

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

* [ ] –ù–∞ `https://krea.acm‚Äëai.ru/krea-test.html` –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Krea.ai.
* [ ] DevTools ‚Üí **Security** ‚Üí TLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ–µ, –Ω–µ—Ç –æ—à–∏–±–æ–∫ Mixed Content.
* [ ] DevTools ‚Üí **Application ‚Üí Cookies** ‚Äî –µ—Å—Ç—å `Domain=krea.acm‚Äëai.ru` cookie (`session`, `flags`, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã).
* [ ] –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ iframe –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚Äî —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.
* [ ] –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤ Network —É—Ö–æ–¥—è—Ç –Ω–∞ `krea.acm‚Äëai.ru`, –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ `krea.ai`.
* [ ] –õ—é–±–æ–π `Set-Cookie` –æ—Ç `krea.ai` Log —Å–æ–¥–µ—Ä–∂–∏—Ç `Domain=krea.acm‚Äëai.ru`.
* [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ CSP / X-Frame-Options / X-Content-Type (–≤ –≤–∫–ª–∞–¥–∫–∞—Ö DevTools).
* [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ ‚Äî —Å—Ü–µ–Ω–∞—Ä–∏–π:

  ```
  curl -I https://krea.acm-ai.ru
  ```

  –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∏–¥–∞ `Set-Cookie: session=xxx; Domain=krea.acm-ai.ru; Secure; SameSite=None`

---

### üìÜ –ü–ª–∞–Ω —Ä–∞–±–æ—Ç

| –≠—Ç–∞–ø | –ó–∞–¥–∞—á–∞                                                 | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π | –°—Ä–æ–∫    |
| ---- | ------------------------------------------------------ | ------------- | ------- |
| 1.   | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ OpenResty —Å –º–æ–¥—É–ª–µ–º Lua                      | DevOps        | 1 –¥–µ–Ω—å  |
| 2.   | –ù–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–≤–∫–ª—é—á–∞—è proxy\_pass –∏ —Ñ–∏–ª—å—Ç—Ä—ã) | Dev           | 1 –¥–µ–Ω—å  |
| 3.   | –ù–∞–ø–∏—Å–∞–Ω–∏–µ Lua-—Ñ–∏–ª—å—Ç—Ä–∞ –¥–ª—è –ø–æ–¥–º–µ–Ω—ã Set-Cookie           | Dev           | 1 –¥–µ–Ω—å  |
| 4.   | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ curl / DevTools / HAR                     | Dev + QA      | 1 –¥–µ–Ω—å  |
| 5.   | –§–∏–Ω–∞–ª—å–Ω—ã–π –∞—É–¥–∏—Ç, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é    | Dev           | 0.5 –¥–Ω—è |

---

### üí¨ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏

* **–°—Ç–∞—Ç–∏—á–Ω—ã–π SPA Krea.ai —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –≤–∫–ª—é—á–µ–Ω–∏—è fetch –ø–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–º—É –∫–æ–¥—É** ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç.
* –ï—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Å–±–æ—Ä–∫–∏ –∫–æ–¥ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ URL, –ø–æ–¥–º–µ–Ω–∞ –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å ‚Äî –Ω—É–∂–Ω–æ —Ä—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ.
* **–õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Krea.ai** (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ bundle, path, –¥–æ–º–µ–Ω–∞) –ø–æ—Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ sub\_filter –∏ Lua-–∫–æ–¥–∞.
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∞–∫–æ–≥–æ –ø—Ä–æ–∫—Å–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Ç–∏–≤ \[–ø—Ä–∞–≤–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Krea.ai] ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ, –∏–Ω–∞—á–µ –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (Terms of Service).

---

### üßæ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

* [ ] DNS/hosts `krea.acm‚Äëai.ru` ‚Üí IP –ø—Ä–æ–∫—Å–∏
* [ ] SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤—ã–ø—É—â–µ–Ω –∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
* [ ] `lua_test` location –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ¬´Lua —Ä–∞–±–æ—Ç–∞–µ—Ç!¬ª
* [ ] `Set-Cookie` domain –ø–æ–¥–º–µ–Ω—è–µ—Ç—Å—è
* [ ] sub\_filter –∑–∞–º–µ–Ω—è–µ—Ç –≤—Å–µ `krea.ai`
* [ ] Network –≤ DevTools ‚Üí –≤—Å–µ req –∏–¥—É—Ç –Ω–∞ `krea.acm‚Äëai.ru`
* [ ] localStorage —Ä–∞–±–æ—á–∏–π, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
* [ ] fetch/ajax –≤ iframe —Ä–∞–±–æ—Ç–∞—é—Ç, –∑–∞–≥–æ–ª–æ–≤–∫–∏ `Origin: krea.acm‚Äëai.ru`

---

–≠—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∏ ‚Äú–±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–æ—Å—Ç—ã–ª–µ–π‚Äù –¢–ó –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ –æ—Ç–∫—Ä—ã—Ç—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É **OpenResty + Lua**.
–ö–æ–≥–¥–∞ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤ ‚Äî –º–æ–≥—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Lua-—Ñ–∞–π–ª (`*.lua`), –ø—Ä–∏–º–µ—Ä `nginx.conf`, –∏ –¥–∞–∂–µ —Å–≤–æ–∏ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è CI/CD –≤ —Å–≤—è–∑–∫–µ —Å Certbot.

[1]: https://www.ruby-forum.com/t/rewriting-the-domain-part-of-set-cookie-in-a-proxy-pass/208025?utm_source=chatgpt.com "Rewriting the domain part of Set-Cookie in a proxy_pass"
[2]: https://github.com/openresty/lua-nginx-module?utm_source=chatgpt.com "openresty/lua-nginx-module: Embed the Power of Lua into ..."
[3]: https://groups.google.com/g/openresty-en/c/bvSGNSCP7tI?utm_source=chatgpt.com "Nginx Lua set-cookie header overwriting / removing any ..."
[4]: https://nginx.org/en/docs/http/ngx_http_proxy_module.html?utm_source=chatgpt.com "Module ngx_http_proxy_module"
[5]: https://stackoverflow.com/questions/72710633/fixing-nginx-sub-filter?utm_source=chatgpt.com "Fixing nginx sub_filter?"
[6]: https://docs.nginx.com/nginx/admin-guide/web-server/web-server/?utm_source=chatgpt.com "Configuring NGINX and NGINX Plus as a Web Server"
[7]: https://stackoverflow.com/questions/45356766/how-to-change-content-length-in-body-filter-by-lua-in-openresty?utm_source=chatgpt.com "How to change Content-length in body_filter_by_lua* in ..."
[8]: https://www.reddit.com/r/nginx/comments/j13wfk/proxy_pass_sub_filter_and_contentencoding_deflate/?utm_source=chatgpt.com "proxy_pass, sub_filter and \"Content-Encoding: deflate\""
