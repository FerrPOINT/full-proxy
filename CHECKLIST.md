# –ß–µ–∫-–ª–∏—Å—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¢–ó

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ `krea.acm-ai.ru` –¥–ª—è SSL
- [x] **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SSL** –≤ `nginx.conf`
- [x] **Let's Encrypt –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö
- [x] **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∏—Ñ—Ä—ã** (TLS 1.2, 1.3)
- [x] **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### 2. –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] **HTTP/HTTPS –∑–∞–ø—Ä–æ—Å—ã** ‚Üí `https://krea.ai$request_uri`
- [x] **WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞** –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [x] **CORS –æ–±—Ä–∞–±–æ—Ç–∫–∞** –¥–ª—è iframe
- [x] **OPTIONS –∑–∞–ø—Ä–æ—Å—ã** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

### 3. –ü–µ—Ä–µ—Ö–≤–∞—Ç –∏ –ø–æ–¥–º–µ–Ω–∞ `Set-Cookie`
- [x] **header_filter_by_lua_block** –≤ `nginx.conf`
- [x] **cookie_filter.lua** –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- [x] **–ü–æ–¥–º–µ–Ω–∞ –¥–æ–º–µ–Ω–æ–≤**: `krea.ai` ‚Üí `krea.acm-ai.ru`
- [x] **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤**: Secure, SameSite, etc.
- [x] **–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤**

### 4. –ü–æ–¥–º–µ–Ω–∞ URL
- [x] **body_filter_by_lua_block** –≤ `nginx.conf`
- [x] **body_filter.lua** –¥–ª—è –∑–∞–º–µ–Ω—ã URL
- [x] **–£–¥–∞–ª–µ–Ω–∏–µ Content-Length** –¥–ª—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏
- [x] **–û—Ç–∫–ª—é—á–µ–Ω–∏–µ Accept-Encoding** –¥–ª—è sub_filter
- [x] **–ó–∞–º–µ–Ω–∞ –≤—Å–µ—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤**: `https://krea.ai`, `//krea.ai`, etc.

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [x] **X-Frame-Options: ALLOWALL**
- [x] **Content-Security-Policy: frame-ancestors \***
- [x] **Access-Control-Allow-Credentials: true**
- [x] **Allow-Methods, Allow-Headers** –¥–ª—è iframe

### 6. –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `/krea-test.html`
- [x] **Iframe —Å src="https://krea.acm-ai.ru/"**
- [x] **allow –∞—Ç—Ä–∏–±—É—Ç—ã** –¥–ª—è –∫–∞–º–µ—Ä—ã, –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, etc.
- [x] **sandbox –∞—Ç—Ä–∏–±—É—Ç—ã** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [x] **–ë–µ–∑ —Å–∫—Ä–∏–ø—Ç–æ–≤** –≤ iframe

### 7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] **access_log** –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
- [x] **error_log** –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
- [x] **Lua –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –∫—É–∫
- [x] **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

### 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ** OpenResty
- [x] **–í–∞–ª–∏–¥–∞—Ü–∏—è Lua-–º–æ–¥—É–ª—è** –≤ —Ç–µ—Å—Ç–∞—Ö
- [x] **–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏** (`nginx -t && nginx reload`)
- [x] **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –æ—á–∏—Å—Ç–∫–µ** –∫—É–∫–∏ –∏ –∫–µ—à–∞
- [x] **–ü–æ—à–∞–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** –≤ README.md

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
- [x] **Lua —Ä–∞–±–æ—Ç–∞–µ—Ç**: `/lua_test` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "Lua —Ä–∞–±–æ—Ç–∞–µ—Ç!"
- [x] **SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞–ª–∏–¥–Ω—ã–π**: TLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] **Cookie domain –ø–æ–¥–º–µ–Ω–∞**: `Domain=krea.acm-ai.ru`
- [x] **URL –∑–∞–º–µ–Ω–∞**: –≤—Å–µ `krea.ai` ‚Üí `krea.acm-ai.ru`
- [x] **CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏**: –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è iframe
- [x] **Security –∑–∞–≥–æ–ª–æ–≤–∫–∏**: X-Frame-Options, CSP
- [x] **WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞**: Upgrade –∑–∞–≥–æ–ª–æ–≤–∫–∏
- [x] **Proxy –∑–∞–≥–æ–ª–æ–≤–∫–∏**: X-Forwarded, X-Real-IP

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- [x] **–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞**: `https://krea.acm-ai.ru/krea-test.html`
- [x] **DevTools ‚Üí Security**: –Ω–µ—Ç –æ—à–∏–±–æ–∫ Mixed Content
- [x] **DevTools ‚Üí Application ‚Üí Cookies**: –¥–æ–º–µ–Ω `krea.acm-ai.ru`
- [x] **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ iframe**: —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- [x] **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü**: —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- [x] **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**: —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] **Network tab**: –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ `krea.acm-ai.ru`
- [x] **Set-Cookie –ª–æ–≥–∏**: `Domain=krea.acm-ai.ru`
- [x] **–ù–µ—Ç –æ—à–∏–±–æ–∫ CSP/X-Frame-Options**

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
- [x] **curl -I https://krea.acm-ai.ru**: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
- [x] **Set-Cookie —Å –¥–æ–º–µ–Ω–æ–º**: `Domain=krea.acm-ai.ru`

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. OpenResty + Lua
- ‚úÖ **–í—ã–±—Ä–∞–Ω OpenResty** –∫–∞–∫ –æ—Å–Ω–æ–≤–∞
- ‚úÖ **Lua-–º–æ–¥—É–ª–∏** –¥–ª—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ —Ç–µ–ª–æ–º
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤

### 2. –ú–æ–¥—É–ª—å `lua-resty-cookie`
- ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ header_filter_by_lua_block**
- ‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å Set-Cookie** –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- ‚úÖ **–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å Domain, Path, Flags**

### 3. –î–∏—Ä–µ–∫—Ç–∏–≤–∞ `proxy_cookie_domain`
- ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∫–∞–∫ fallback** –≤ `nginx.conf`
- ‚úÖ **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è** –¥–ª—è –ø–æ–¥–º–µ–Ω—ã –¥–æ–º–µ–Ω–æ–≤

### 4. –î–∏—Ä–µ–∫—Ç–∏–≤–∞ `body_filter_by_lua_block` + `sub_filter`
- ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∑–∞–º–µ–Ω–∞ URL** –≤ `body_filter.lua`
- ‚úÖ **–ü–æ–¥–º–µ–Ω–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö —Å—Å—ã–ª–æ–∫**: `https://krea.ai` ‚Üí `https://krea.acm-ai.ru`
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤** –±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

## üìä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. Docker –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- ‚úÖ **Dockerfile** –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ **docker-compose.yml** –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ **Health checks** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
- ‚úÖ **–°–∫—Ä–∏–ø—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –û–°
- ‚úÖ **–°–∫—Ä–∏–ø—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** —Å —Ü–≤–µ—Ç–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
- ‚úÖ **–°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** —Å–µ—Ä–≤–∏—Å–æ–º

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ SSL —à–∏—Ñ—Ä—ã**
- ‚úÖ **CSP –∑–∞–≥–æ–ª–æ–≤–∫–∏** –¥–ª—è iframe
- ‚úÖ **XSS –∑–∞—â–∏—Ç–∞**
- ‚úÖ **Sandbox –∞—Ç—Ä–∏–±—É—Ç—ã** –≤ iframe

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- ‚úÖ **Health checks**
- ‚úÖ **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```
full-proxy/
‚îú‚îÄ‚îÄ nginx.conf              # ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ lua/
‚îÇ   ‚îú‚îÄ‚îÄ cookie_filter.lua   # ‚úÖ –§–∏–ª—å—Ç—Ä Set-Cookie
‚îÇ   ‚îî‚îÄ‚îÄ body_filter.lua     # ‚úÖ –§–∏–ª—å—Ç—Ä URL –∑–∞–º–µ–Ω—ã
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ install.sh          # ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ OpenResty
‚îÇ   ‚îú‚îÄ‚îÄ test.sh            # ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ manage.sh          # ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º
‚îÇ   ‚îî‚îÄ‚îÄ docker-deploy.sh   # ‚úÖ Docker —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ Dockerfile              # ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ docker-compose.yml      # ‚úÖ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ README.md              # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ DEPLOYMENT.md          # ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ CHECKLIST.md           # ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
‚îî‚îÄ‚îÄ .gitignore             # ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏—è Git
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **nginx.conf**
   - ‚úÖ SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
   - ‚úÖ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
   - ‚úÖ WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞
   - ‚úÖ Lua-—Ñ–∏–ª—å—Ç—Ä—ã
   - ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

2. **cookie_filter.lua**
   - ‚úÖ –ü–µ—Ä–µ—Ö–≤–∞—Ç Set-Cookie
   - ‚úÖ –ü–æ–¥–º–µ–Ω–∞ –¥–æ–º–µ–Ω–æ–≤
   - ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **body_filter.lua**
   - ‚úÖ –ó–∞–º–µ–Ω–∞ URL
   - ‚úÖ –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è
   - ‚úÖ Content-Type —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

4. **–°–∫—Ä–∏–ø—Ç—ã**
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
   - ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
   - ‚úÖ Docker –ø–æ–¥–¥–µ—Ä–∂–∫–∞

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¢–ó –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:**

- ‚úÖ **8 –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–∞–¥–∞—á** –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- ‚úÖ **8 –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø—Ä–∏—ë–º–∫–∏** –ø–æ–∫—Ä—ã—Ç—ã
- ‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è** —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¢–ó
- ‚úÖ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è** –¥–æ–±–∞–≤–ª–µ–Ω—ã
- ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –ø–æ–ª–Ω–∞—è –∏ –ø–æ–¥—Ä–æ–±–Ω–∞—è
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

**–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é!** üöÄ 