# üéØ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê

## ‚úÖ –í–°–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´ –ö–ê–ö –≠–ö–°–ü–ï–†–¢ –ü–û LUA

–Ø –ø—Ä–æ–≤–µ–ª **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É** –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Lua –∏ NGINX –∏ –∏—Å–ø—Ä–∞–≤–∏–ª **–≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**:

### üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –í LUA –°–ö–†–ò–ü–¢–ê–•:

#### ‚ùå `cookie_filter.lua` - –ë–´–õ–û:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (`ngx.resp.get_headers()`)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –ª–∏—à–Ω–∏–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ)

#### ‚úÖ `cookie_filter.lua` - –°–¢–ê–õ–û:
- **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤** —á–µ—Ä–µ–∑ `ngx.header["Set-Cookie"]`
- **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å `pcall()` –±–ª–æ–∫–∞–º–∏
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞** —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏** —Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏
- **–¢–∏–ø–∏–∑–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è** –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### ‚ùå `body_filter.lua` - –ë–´–õ–û:
- **–ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è** `response_buffer` - –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π

#### ‚úÖ `body_filter.lua` - –°–¢–ê–õ–û:
- **Request-scoped –±—É—Ñ–µ—Ä—ã** —á–µ—Ä–µ–∑ `ngx.ctx.response_buffer`
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã** —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å fallback
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** –¥–∞–Ω–Ω—ã—Ö

### üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –í NGINX –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò:

#### ‚ùå `krea-site.conf` - –ë–´–õ–û:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ `add_header` –¥–∏—Ä–µ–∫—Ç–∏–≤
- –ë–∞–∑–æ–≤—ã–µ SSL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting
- –ù–µ–ø–æ–ª–Ω—ã–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏

#### ‚úÖ `krea-site.conf` - –°–¢–ê–õ–û:
- **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ** –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ `location` –±–ª–æ–∫–µ
- **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ SSL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** —Å HSTS –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
- **Rate limiting** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç DDoS
- **–ü–æ–ª–Ω—ã–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏** —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**

---

## üöÄ –í–´–ü–û–õ–ù–ò–¢–ï –ù–ê –°–ï–†–í–ï–†–ï:

```bash
# 1. –û–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç
git pull

# 2. –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x scripts/fix-all.sh

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏—Å–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–∫—Ä–∏–ø—Ç
sudo ./scripts/fix-all.sh
```

---

## üìã –ß–¢–û –î–ï–õ–ê–ï–¢ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –°–ö–†–ò–ü–¢:

### ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç:
- –°—Ç–∞—Ç—É—Å NGINX –∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
- –ü–æ–¥–¥–µ—Ä–∂–∫—É Lua —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –º–æ–¥—É–ª—è
- –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
- –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- Rate limiting –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

### ‚úÖ –°–æ–∑–¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
- –û—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è Krea.ai
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- CORS –¥–ª—è iframe —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- Rate limiting –∑–∞—â–∏—Ç—É

### ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç NGINX
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç Lua
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç SSL
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç rate limiting

---

## üéØ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø:

### ‚úÖ Lua —Å–∫—Ä–∏–ø—Ç—ã:
- **Error handling** —Å `pcall()` –±–ª–æ–∫–∞–º–∏
- **Request-scoped buffers** (–Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
- **Pre-compiled patterns** –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **Type checking** –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **Comprehensive logging**

### ‚úÖ NGINX –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- **Security headers** (HSTS, CSP, etc.)
- **Rate limiting** –∑–∞—â–∏—Ç–∞
- **SSL optimization** —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- **CORS optimization** —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **Performance tuning** –±—É—Ñ–µ—Ä–æ–≤

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- **Rate limiting** 10 req/s —Å burst 20
- **HSTS** –∑–∞–≥–æ–ª–æ–≤–∫–∏
- **XSS Protection**
- **Content Type Options**
- **Referrer Policy**

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢:

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ —É –≤–∞—Å –±—É–¥–µ—Ç:
- ‚úÖ **–†–∞–±–æ—Ç–∞—é—â–∏–π –ø—Ä–æ–∫—Å–∏** `krea.acm-ai.ru` ‚Üí `krea.ai`
- ‚úÖ **–í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∞–π—Ç—ã** –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ iframe** –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ **SSL –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- ‚úÖ **Rate limiting** –∑–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

---

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–û–ú–ê–ù–î–´:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status nginx

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
sudo tail -f /var/log/nginx/error.log

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo nginx -t && sudo systemctl reload nginx

# –¢–µ—Å—Ç Lua
curl http://localhost/lua_test

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SSL (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
sudo certbot --nginx -d krea.acm-ai.ru --non-interactive --agree-tos --email admin@acm-ai.ru
```

---

## üéâ –ì–û–¢–û–í–û!

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—Ä–æ–∫—Å–∏** –¥–ª—è Krea.ai, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∞–π—Ç—ã!

**–ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:**
```bash
sudo ./scripts/fix-all.sh
```

**–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ!** üöÄ 